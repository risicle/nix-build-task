resources:
  - name: nix-build-task-git
    type: git
    icon: git
    source:
      uri: https://github.com/risicle/nix-build-task.git
      branch: ((working-branch))
  - name: nix-build-task-git-bump-sources-branch
    type: git
    icon: git
    source:
      uri: git@github.com:risicle/nix-build-task.git
      branch: ((bump-sources-branch))
      private_key: ((github-ssh-key))
  - name: nix-build-task-staging-dockerhub
    type: registry-image
    icon: docker
    source:
      tag: latest
      repository: ((staging-docker-repo))
      username: ((dockerhub-username))
      password: ((dockerhub-password))
  - name: nix-build-task-final-dockerhub
    type: registry-image
    icon: docker
    source:
      tag: latest
      repository: ((final-docker-repo))
      username: ((dockerhub-username))
      password: ((dockerhub-password))
  - name: every-friday-night
    type: time
    icon: timer-outline
    source:
      location: Europe/London
      start: 23:00
      stop: 23:30
      days: [Friday]

jobs:
  - name: update-pipeline
    serial: true
    plan:
    - get: nix-build-task-git
      trigger: true
    - set_pipeline: self
      file: nix-build-task-git/ci/build.yml
      vars:
        working-branch: ((working-branch))
        staging-docker-repo: ((staging-docker-repo))
        final-docker-repo: ((final-docker-repo))
        bump-sources-branch: ((bump-sources-branch))
        cachix-cache: ((cachix-cache))
        cachix-dhall: ((cachix-dhall))
        cachix-signing-key: ((cachix-signing-key))
        dockerhub-username: ((dockerhub-username))
        dockerhub-password: ((dockerhub-password))
        github-ssh-key: ((github-ssh-key))

  - name: bootstrap-image
    serial: true
    plan:
      - get: nix-build-task-git
        passed: [update-pipeline]
        trigger: true
      - task: stage-0-build
        output_mapping:
          output: stage-0-image
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: nixos/nix
              tag: sha256:840bec8bcedf4858ddc525e1a9f41240c2c2a1380fd5315e756119ef66a0aed6
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: output
          params:
            CACHIX_SIGNING_KEY: ((cachix-signing-key))
          run:
            # rely on PATH to find bash
            path: bash
            args:
              - -e
              - -c
              - |
                CACHIX=$(nix-build '<nixpkgs>' -A cachix)/bin/cachix

                # TODO re-enable cachix use in bootstrap once we're using a
                # more modern image to bootstrap from (with a zstd-supporting
                # nix)
                ## using but not pushing to cache from stage-0
                #$CACHIX use ((cachix-cache))

                nix-channel --add https://nixos.org/channels/nixos-21.11 nixpkgs
                nix-channel --update
                SKOPEO=$(nix-build '<nixpkgs>' -A skopeo)/bin/skopeo
                OCI_IMAGE_TOOL=$(nix-build '<nixpkgs>' -A oci-image-tool)/bin/oci-image-tool
                JQ=$(nix-build '<nixpkgs>' -A jq)/bin/jq

                nix-build nix-build-task-git -A image
                gzip -dc result > output/image.tar
                $SKOPEO inspect docker-archive:output/image.tar > image.json
                $JQ '.Digest' image.json > output/digest
                $JQ '{env: .Env, user: .User}' image.json > output/metadata.json
                $SKOPEO --insecure-policy copy docker-archive:output/image.tar oci:oci_dir:latest
                $OCI_IMAGE_TOOL unpack oci_dir output/rootfs --ref name=latest

      - task: stage-1-build
        image: stage-0-image
        output_mapping:
          output0: stage-1-image
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: output0
          params:
            NIXFILE: nix-build-task-git
            ATTR0: image
            OUTPUT0_PREPARE_IMAGE: 1
            # TODO re-enable cachix use in bootstrap once we're using a
            # more modern image to bootstrap from (with a zstd-supporting
            # nix)
            #CACHIX_CACHE: ((cachix-cache))
            #CACHIX_SIGNING_KEY: ((cachix-signing-key))
          run:
            path: /bin/build

      - put: nix-build-task-staging-dockerhub
        params:
          image: stage-1-image/image.tar

  - name: test-build-images
    serial: true
    plan:
      - in_parallel:
        - get: nix-build-task-staging-dockerhub
          passed: [bootstrap-image]
          trigger: true
        - get: nix-build-task-git
          passed: [bootstrap-image]
          trigger: true
      - task: build-multiple
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: hopefully-alpine-image
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/images.nix
            OUTPUT_PREPARE_IMAGE: unpack
            OUTPUT1_PREPARE_IMAGE: 1  # should be ignored
          run:
            path: /bin/build
      - task: check-alpine
        image: hopefully-alpine-image
        config:
          platform: linux
          inputs:
            - name: hopefully-alpine-image
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                stat hopefully-alpine-image/result
                stat hopefully-alpine-image/result-2
                stat hopefully-alpine-image/result-3
                stat hopefully-alpine-image/digest
                stat hopefully-alpine-image/image.tar
                cat /etc/alpine-release
      - task: build-separate
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: separate-skopeo-alone-image
              path: output
            - name: separate-cf-cli-image
              path: output1
          params:
            NIXFILE: nix-build-task-git/tests/images.nix
            ATTR: skopeo-alone
            ATTR1: cf-cli-shell
            ATTR2: alpine-fetched  # deliberately missing output for this
            OUTPUT0_PREPARE_IMAGE: 1
            OUTPUT1_PREPARE_IMAGE: unpack
          run:
            path: /bin/build
      - task: check-cf-cli-shell
        image: separate-cf-cli-image
        config:
          platform: linux
          inputs:
            - name: separate-skopeo-alone-image
          run:
            path: /bin/bash
            args:
              - -e
              - -c
              - |
                cf help
                if ! [[ -a separate-skopeo-alone-image/image.tar ]] ; then
                  echo "separate-skopeo-alone-image/image.tar missing"
                  exit 7
                fi
                if [[ -a separate-skopeo-alone-image/rootfs ]] ; then
                  echo "separate-skopeo-alone-image/rootfs shouldn't exist"
                  exit 8
                fi
                if [[ "$CF_USERNAME" != 'foo' ]] ; then
                  echo "CF_USERNAME should be 'foo', not '$CF_USERNAME'"
                  exit 9
                fi

  - name: test-build-other
    serial: true
    plan:
      - in_parallel:
        - get: nix-build-task-staging-dockerhub
          passed: [bootstrap-image]
          trigger: true
        - get: nix-build-task-git
          passed: [bootstrap-image]
          trigger: true
      - task: build-busybox-image
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: busybox-image
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/images.nix
            ATTR: literally-just-busybox
            OUTPUT_PREPARE_IMAGE: unpack
          run:
            path: /bin/build
      - task: build-dirs
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: linux-dirs
              path: output0
            - name: multi-out-baz
              path: output1
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR0: linux-dir
            ATTR1: multiOut.baz
            ATTR44: doesntExist  # should be ignored but generate warning
          run:
            path: /bin/build
      - task: check-dirs
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: linux-dirs
            - name: multi-out-baz
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                # check dirs have no links
                find linux-dirs -type l > found_symlinks
                if [ -n "$(cat found_symlinks)" ] ; then
                  echo "Output should have no symlinks, found:"
                  cat found_symlinks
                  exit 7
                fi

                stat linux-dirs/result/README.md
                stat linux-dirs/result/linux_1_0.tar.gz
                stat multi-out-baz/result
      - try:
          task: fail-to-unpack-non-image
          image: nix-build-task-staging-dockerhub
          config:
            platform: linux
            inputs:
              - name: nix-build-task-git
            outputs:
              - name: linux-1-0
                path: output0
            params:
              NIXFILE: nix-build-task-git/tests/other.nix
              ATTR0: linux_1_0
              OUTPUT_PREPARE_IMAGE: unpack
            run:
              path: /bin/build
          on_failure:
            task: record-unpack-failure
            image: busybox-image
            config:
              platform: linux
              outputs:
                - name: linux-1-0
              run:
                path: /bin/ash
                args:
                  - -e
                  - -c
                  - |
                    touch linux-1-0/failure-recorded
      - task: check-unpack-failure
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: linux-1-0
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                if ! [ -e linux-1-0/failure-recorded ] ; then
                  echo "Expected linux-1-0/failure-recorded to have been created by record-unpack-failure"
                  exit 7
                fi
      - task: build-with-args
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: args-output
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR0: linux-dir
            BUILD_ARGSTR_readmeExt: .txt
            BUILD_ARG_includeTarball: 1 == 2
          run:
            path: /bin/build
      - task: check-args-effect
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: args-output
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                if [ -e args-output/result/linux_1_0.tar.gz ] ; then
                  echo "Output shouldn't include tarball"
                  exit 7
                fi

                stat args-output/result/README.txt
      - task: build-non-deterministic
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: logs-out
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            NIX_LOG_DIR: logs-out/
          run:
            path: /bin/build
      - task: check-non-deterministic-logs
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: logs-out
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                for f in $(find logs-out -name '*.bz2') ; do
                  bunzip2 -c $f >> all_logs
                done
                egrep 'Building something slightly random' all_logs
      - task: build-alt-system-option
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: alt-system-output
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: bash
            NIX_OPTION_system: i686-linux
          run:
            path: /bin/build
      - task: check-output-arch
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: alt-system-output
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                ELF_CLASS_BYTE="$(hexdump -e '"0x%02x"' -n 1 -s 4 < alt-system-output/result/bin/bash)"
                if [ "$ELF_CLASS_BYTE" != '0x01' ] ; then
                  echo "Expected output binary's ELF_CLASS_BYTE to be 0x01 (32-bit) but was $ELF_CLASS_BYTE"
                  exit 7
                fi
      - task: build-with-nar-export
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-nar
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            OUTPUT_EXPORT_NAR: true
          run:
            path: /bin/build
      - task: build-with-nar-export-runtime-closure
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-nar-runtime-closure
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            OUTPUT_EXPORT_NAR: runtime-closure
          run:
            path: /bin/build
      - task: check-nars
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: nd-nar
            - name: nd-nar-runtime-closure
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                if [ "$(stat -c '%s' nd-nar/result.nar)" -ge "$(stat -c '%s' nd-nar-runtime-closure/result.nar)" ] ; then
                  echo "Expected nd-nar-runtime-closure/result.nar to be larger than nd-nar/result.nar"
                  exit 7
                fi

                if strings nd-nar/result.nar | grep -F 'contained-default-rtd-contained' ; then
                  echo "Expected contents of runtime dependency not to be included in nd-nar/result.nar"
                  exit 8
                fi
                if ! strings nd-nar-runtime-closure/result.nar | grep -F 'contained-default-rtd-contained' ; then
                  echo "Expected contents of runtime dependency to be included in nd-nar-runtime-closure/result.nar"
                  exit 9
                fi

                for f in nd-nar/result.nar nd-nar-runtime-closure/result.nar ; do
                  NAR_HEAD=$(strings $f | head -n 1)
                  if [ "$NAR_HEAD" != "nix-archive-1" ] ; then
                    echo "Expected first string of $f to be 'nix-archive-1', instead was '$NAR_HEAD'"
                    exit 10
                  fi
                done

  - name: test-eval-outpaths
    serial: true
    plan:
      - in_parallel:
        - get: nix-build-task-staging-dockerhub
          passed: [bootstrap-image]
          trigger: true
        - get: nix-build-task-git
          passed: [bootstrap-image]
          trigger: true
      - task: eval-busybox-image
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: busybox-outpath
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/images.nix
            ATTR: literally-just-busybox
          run:
            path: /bin/build
            args:
              - eval-outpaths
      - task: build-busybox-image
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: busybox-image
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/images.nix
            ATTR: literally-just-busybox
            OUTPUT_PREPARE_IMAGE: unpack
          run:
            path: /bin/build
      - task: compare-outpaths
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: busybox-image
            - name: busybox-outpath
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                diff -u busybox-image/result.outpath busybox-outpath/result.outpath
                echo "No difference detected"
      - task: eval-multi-out
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: multi-out-outpath
              path: output
            - name: multi-out-baz-outpath
              path: output1
            - name: multi-out-foo-outpath
              path: output2
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR0: multiOut
            ATTR1: multiOut.baz
            ATTR2: multiOut.foo
            OUTPUT2_PREPARE_IMAGE: unpack  # should have no effect
          run:
            path: /bin/build
            args:
              - eval-outpaths
      - task: check-multi-out
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: multi-out-outpath
            - name: multi-out-baz-outpath
            - name: multi-out-foo-outpath
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                egrep -e '^[^-]+-multi-out-foo$' multi-out-outpath/result.outpath
                egrep -e '^[^-]+-multi-out-foo-baz$' multi-out-baz-outpath/result.outpath
                egrep -e '^[^-]+-multi-out-foo-foo$' multi-out-foo-outpath/result.outpath
      - task: eval-no-args
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: linux-dir-no-args
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR0: linux-dir
          run:
            path: /bin/build
            args:
              - eval-outpaths
      - task: eval-args-buz
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: linux-dir-args-buz
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR0: linux-dir
            BUILD_ARGSTR_readmeExt: buz
          run:
            path: /bin/build
            args:
              - eval-outpaths
      - task: check-args-results
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: linux-dir-no-args
            - name: linux-dir-args-buz
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                if diff -u linux-dir-no-args/result.outpath linux-dir-args-buz/result.outpath ; then
                  echo "Expected outputs linux-dir-no-args and linux-dir-args-buz to be different"
                  exit 7
                fi

  - name: test-cachix
    serial: true
    plan:
      - in_parallel:
        - get: nix-build-task-staging-dockerhub
          passed: [bootstrap-image]
          trigger: true
        - get: nix-build-task-git
          passed: [bootstrap-image]
          trigger: true
      - task: build-busybox-image
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: busybox-image
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/images.nix
            ATTR: busybox-with-curl
            OUTPUT_PREPARE_IMAGE: unpack
            CACHIX_CACHE: ((cachix-cache))
            CACHIX_SIGNING_KEY: ((cachix-signing-key))
          run:
            path: /bin/build
      - task: generate-run-random
        image: busybox-image
        config:
          platform: linux
          outputs:
            - name: run-random-output
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                hexdump -e '/1 "%02x"' -n 8 /dev/random > run-random-output/value
      - load_var: run-random
        file: run-random-output/value
        format: trim
        reveal: true
      - task: build-nd-nokey-emptycache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-nokey-emptycache
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            BUILD_ARGSTR_someArg: ((.:run-random))
            CACHIX_CACHE: ((cachix-cache))
          run:
            path: /bin/build
      - task: build-nd-nopush-emptycache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-nopush-emptycache
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            BUILD_ARGSTR_someArg: ((.:run-random))
            CACHIX_CACHE: ((cachix-cache))
            CACHIX_SIGNING_KEY: ((cachix-signing-key))
            CACHIX_PUSH: no  # yaml false
          run:
            path: /bin/build
      - task: check-cache-empty
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: nd-nopush-emptycache
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                OUTPATH_HASH=$(egrep -o '\b[a-z0-9]{32}\b' nd-nopush-emptycache/result.outpath)
                URL="https://((cachix-cache)).cachix.org/$OUTPATH_HASH.narinfo"
                echo "Probing $URL"
                STATUS_CODE=$(curl -s -o /dev/null -w '%{http_code}' "$URL")
                if [ "$STATUS_CODE" != '404' ] ; then
                  echo "Expected to get 404 when checking cache, got $STATUS_CODE"
                  exit 7
                fi
      - task: build-nd-emptycache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-emptycache
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            BUILD_ARGSTR_someArg: ((.:run-random))
            CACHIX_CACHE: ((cachix-cache))
            CACHIX_SIGNING_KEY: ((cachix-signing-key))
          run:
            path: /bin/build
      - task: check-cache-present
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: nd-emptycache
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                OUTPATH_HASH=$(egrep -o '\b[a-z0-9]{32}\b' nd-emptycache/result.outpath)
                URL="https://((cachix-cache)).cachix.org/$OUTPATH_HASH.narinfo"
                echo "Probing $URL"
                curl -f $URL > /dev/null
      - task: build-nd-nokey-presentcache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-nokey-presentcache
              path: output0
            - name: ndbtd-nokey-presentcache
              path: output1
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            ATTR1: deliberatelyNonDeterministicBTD
            BUILD_ARGSTR_someArg: ((.:run-random))
            CACHIX_CACHE: ((cachix-cache))
          run:
            path: /bin/build
      - task: build-nd-presentcache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-presentcache
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            BUILD_ARGSTR_someArg: ((.:run-random))
            CACHIX_CACHE: ((cachix-cache))
            CACHIX_SIGNING_KEY: ((cachix-signing-key))
          run:
            path: /bin/build
      - task: check-cached-outputs-used
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: nd-emptycache
            - name: nd-nokey-presentcache
            - name: ndbtd-nokey-presentcache
            - name: nd-presentcache
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                # if the cache was used, even the nondeterministic output should be
                # identical (including the flattened link to the nondeterministic
                # runtime dependency)
                if ! diff -ru nd-emptycache nd-nokey-presentcache ; then
                  echo "Expected nd-emptycache, nd-nokey-presentcache outputs to be identical"
                  exit 7
                fi
                if ! diff -ru nd-emptycache nd-presentcache ; then
                  echo "Expected nd-emptycache, nd-presentcache outputs to be identical"
                  exit 7
                fi
                # if the cache had *all* built derivations pushed to it, the snapshot
                # of the buildtime dependency should be the same as the re-"built" one
                if ! diff -ru nd-emptycache/result/build-time-dep ndbtd-nokey-presentcache/result ; then
                  echo "Expected nd-emptycache/result/build-time-dep, ndbtd-nokey-presentcache/result to be identical"
                  exit 7
                fi
      - task: cachix-dhall-to-file
        image: busybox-image
        config:
          platform: linux
          outputs:
            - name: cachix-conf
          params:
            CACHIX_DHALL: ((cachix-dhall))
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                echo "$CACHIX_DHALL" > cachix-conf/cachix.dhall
      - task: build-nd-dhall-emptycache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
            - name: cachix-conf
          outputs:
            - name: nd-dhall-emptycache
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            BUILD_ARGSTR_someArg: ((.:run-random))-dhall
            CACHIX_CACHE: ((cachix-cache))
            CACHIX_CONF: cachix-conf/cachix.dhall
          run:
            path: /bin/build
      - task: build-nd-dhall-nokey-presentcache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-dhall-nokey-presentcache
              path: output
            - name: ndbtd-dhall-nokey-presentcache
              path: output1
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR: deliberatelyNonDeterministic
            ATTR1: deliberatelyNonDeterministicBTD
            BUILD_ARGSTR_someArg: ((.:run-random))-dhall
            CACHIX_CACHE: ((cachix-cache))
          run:
            path: /bin/build
      - task: check-cached-outputs-used-dhall
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: nd-dhall-emptycache
            - name: nd-dhall-nokey-presentcache
            - name: ndbtd-dhall-nokey-presentcache
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                # if the cache was used, even the nondeterministic output should be
                # identical (including the flattened link to the nondeterministic
                # runtime dependency)
                if ! diff -ru nd-dhall-emptycache nd-dhall-nokey-presentcache ; then
                  echo "Expected nd-dhall-emptycache, nd-dhall-nokey-presentcache outputs to be identical"
                  exit 7
                fi
                # if the cache had *all* built derivations pushed to it, the snapshot
                # of the buildtime dependency should be the same as the re-"built" one
                if ! diff -ru nd-dhall-emptycache/result/build-time-dep ndbtd-dhall-nokey-presentcache/result ; then
                  echo "Expected nd-dhall-emptycache/result/build-time-dep, ndbtd-dhall-nokey-presentcache/result to be identical"
                  exit 7
                fi
      - task: build-nd-pushoutputs-emptycache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-pushoutputs-emptycache
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR0: deliberatelyNonDeterministic
            BUILD_ARGSTR_someArg: ((.:run-random))-pushoutputs
            CACHIX_CACHE: ((cachix-cache))
            CACHIX_SIGNING_KEY: ((cachix-signing-key))
            CACHIX_PUSH: outputs
          run:
            path: /bin/build
      - task: build-nd-pushoutputs-nokey-presentcache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-pushoutputs-nokey-presentcache
              path: output
            - name: ndbtd-pushoutputs-nokey-presentcache
              path: output1
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR0: deliberatelyNonDeterministic
            ATTR1: deliberatelyNonDeterministicBTD
            BUILD_ARGSTR_someArg: ((.:run-random))-pushoutputs
            CACHIX_CACHE: ((cachix-cache))
          run:
            path: /bin/build
      - task: check-cached-outputs-used-pushoutputs
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: nd-pushoutputs-emptycache
            - name: nd-pushoutputs-nokey-presentcache
            - name: ndbtd-pushoutputs-nokey-presentcache
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                # if the cache was used, even the nondeterministic output should be
                # identical (including the flattened link to the nondeterministic
                # runtime dependency)
                if ! diff -ru nd-pushoutputs-emptycache nd-pushoutputs-nokey-presentcache ; then
                  echo "Expected nd-pushoutputs-emptycache, nd-pushoutputs-nokey-presentcache outputs to be identical"
                  exit 7
                fi
                # if the cache had *all* built derivations pushed to it, the snapshot
                # of the buildtime dependency would be the same as the re-"built" one
                if diff -ru nd-pushoutputs-emptycache/result/build-time-dep ndbtd-pushoutputs-nokey-presentcache/result ; then
                  echo "Expected nd-pushoutputs-emptycache/result/build-time-dep, ndbtd-pushoutputs-nokey-presentcache/result to different, but appeared to be identical"
                  exit 7
                fi
      - task: build-nd-pushomdrv-emptycache
        image: nix-build-task-staging-dockerhub
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nd-pushomdrv-emptycache
              path: output
          params:
            NIXFILE: nix-build-task-git/tests/other.nix
            ATTR0: deliberatelyNonDeterministic
            BUILD_ARGSTR_someArg: ((.:run-random))-pushomdrv
            CACHIX_CACHE: ((cachix-cache))
            CACHIX_SIGNING_KEY: ((cachix-signing-key))
            CACHIX_PUSH_EXTRA_ARGS: --omit-deriver -c 1
          run:
            path: /bin/build
      - task: check-nd-pushomdrv-cache-no-deriver
        image: busybox-image
        config:
          platform: linux
          inputs:
            - name: nd-pushomdrv-emptycache
          run:
            path: /bin/ash
            args:
              - -e
              - -c
              - |
                OUTPATH_HASH=$(egrep -o '\b[a-z0-9]{32}\b' nd-pushomdrv-emptycache/result.outpath)
                URL="https://((cachix-cache)).cachix.org/$OUTPATH_HASH.narinfo"
                echo "Probing $URL"
                curl -f $URL | egrep '^Deriver: unknown-deriver$'

  - name: push-final
    serial: true
    plan:
      - in_parallel:
        - get: nix-build-task-staging-dockerhub-oci
          resource: nix-build-task-staging-dockerhub
          passed:
            - test-build-images
            - test-build-other
            - test-cachix
            - test-eval-outpaths
          trigger: true
          params:
            format: oci
        - get: nix-build-task-staging-dockerhub-rootfs
          resource: nix-build-task-staging-dockerhub
          passed:
            - test-build-images
            - test-build-other
            - test-cachix
            - test-eval-outpaths
          trigger: true
        - get: nix-build-task-git
          passed:
            - test-build-images
            - test-build-other
            - test-cachix
            - test-eval-outpaths
          trigger: true
          params:
            fetch_tags: true
      - task: build-busybox-git-image
        image: nix-build-task-staging-dockerhub-rootfs
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: busybox-git-image
              path: output
          params:
            NIXFILE: nix-build-task-git/
            ATTR: busyboxGitImage
            OUTPUT_PREPARE_IMAGE: unpack
          run:
            path: /bin/build
      - task: check-for-git-version-tag
        image: busybox-git-image
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          run:
            dir: nix-build-task-git
            path: /bin/bash
            args:
              - -e
              - -c
              - |
                while read -r TAG ; do
                  if [ "$TAG" = "v$(cat ./VERSION)" ] ; then
                    echo "found tag $TAG"
                    exit 0
                  fi
                done < <(git tag --points-at HEAD)  # avoid loop being in subshell
                echo "no tag matching VERSION $(cat ./VERSION): not proceeding with push"
                exit 1
      - put: nix-build-task-final-dockerhub
        params:
          image: nix-build-task-staging-dockerhub-oci/image.tar
          additional_tags: nix-build-task-git/VERSION

  - name: bump-sources
    serial: true
    plan:
      - get: every-friday-night
        trigger: true
      - get: nix-build-task-git
        passed: [update-pipeline]
        trigger: false
      - task: build-bump-sources-image
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: risicle/nix-build-task
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: bump-sources-image
              path: output
          params:
            NIXFILE: nix-build-task-git/
            ATTR: bumpSourcesImage
            OUTPUT_PREPARE_IMAGE: unpack
          run:
            path: /bin/build
      - task: clone-and-bump
        image: bump-sources-image
        config:
          platform: linux
          inputs:
            - name: nix-build-task-git
          outputs:
            - name: nix-build-task-git-bumped
          run:
            path: /bin/bash
            args:
              - -e
              - -c
              - |
                git clone nix-build-task-git nix-build-task-git-bumped

                pushd nix-build-task-git-bumped
                bump-sources 2>&1 | tee .bump-sources-output
                popd
      - in_parallel:
        - task: eval-orig-outpaths
          config:
            platform: linux
            image_resource:
              type: registry-image
              source:
                repository: risicle/nix-build-task
            inputs:
              - name: nix-build-task-git
            outputs:
              - name: orig-outpaths
                path: output
            params:
              NIXFILE: nix-build-task-git/
              ATTR: image
            run:
              path: /bin/build
              args:
                - eval-outpaths
        - task: eval-bumped-outpaths
          config:
            platform: linux
            image_resource:
              type: registry-image
              source:
                repository: risicle/nix-build-task
            inputs:
              - name: nix-build-task-git-bumped
            outputs:
              - name: bumped-outpaths
                path: output
            params:
              NIXFILE: nix-build-task-git-bumped/
              ATTR: image
            run:
              path: /bin/build
              args:
                - eval-outpaths
      - try:
          task: compare-and-commit
          image: bump-sources-image
          config:
            platform: linux
            inputs:
              - name: nix-build-task-git
              - name: nix-build-task-git-bumped
              - name: orig-outpaths
              - name: bumped-outpaths
            outputs:
              - name: nix-build-task-git-bumped
            run:
              path: /bin/bash
              args:
                - -e
                - -c
                - |
                  if diff -ru orig-outpaths bumped-outpaths ; then
                    echo "No difference detected"
                    exit 7
                  fi

                  echo "Difference detected"

                  pushd nix-build-task-git-bumped

                  echo -n $'bump sources\n\noutput from bump-sources:\n\n' >> .message
                  cat .bump-sources-output >> .message

                  git checkout -b bump-sources

                  git config user.email 'bump.sources@humanleg.org.uk'
                  git config user.name 'bump-sources'
                  git commit --all --file=.message

                  bump-minor-version
                  git add ./VERSION
                  git commit -m "bump version to $(cat ./VERSION)"

          on_success:
            put: nix-build-task-git-bump-sources-branch
            params:
              repository: nix-build-task-git-bumped
              force: true
